# hassio-yandex2mqtt
Yandex2mqtt hassio addon

## О плагине
Плагин позволяет установить и использовать мост из Яндекс УД в MQTT.

Плагин является форком оригинального проекта от gostest:
https://github.com/gostest/hassio-yandex2mqtt.

Репозиторий самого моста:
https://github.com/dparhonin/yandex2mqtt (форк проекта https://github.com/munrexio/yandex2mqtt).
Там же указаны ссылки на статьи оригинального автора на хабре, как его настраивать и как с ним работать.

Сам плагин и скрипты сборки сделаны по мотивам:  
https://github.com/danielwelch/hassio-zigbee2mqtt.

## Установка
В Hassio перейти на вкладку Hass.io -> Add-on Store
Там в разделе Repositories добавить новый репозиторий по адресу https://github.com/dparhonin/hassio-yandex2mqtt.
Установить плагин Yandex2MQTT.

## Настройка
1. Необходимо настроить ssl, без этого ничего работать не будет. Хорошим решением будет использование аддона Let's Encrypt. Также необходимо использование статического ip-адреса либо DDNS-сервиса, как описано в статье munrexio.
ЗЫ. Кстати, если вы являетесь счастливым обладателем роутера mikrotik, то там есть встроенный DDNS. Надо зайти в IP->Cloud и в строке DNS будет доменное имя вашего роутера.
2. Необходимо настроить mqtt. Есть большое количество mqtt аддонов для Hassio, выбирайте который больше нравится. В качестве адреса необходимо прописать внешний адрес сервера, на котором утановлен Hassio, 127.0.0.1 или localhost вероятно не заработают.
3. Порт я бы поставил отличный от 443. Я использую 4443 и соответственно порт форвардинг на роутере надо настроить на этот порт.

Все дальнейшие шаги можно почитать в описании настройки моста:
https://github.com/dparhonin/yandex2mqtt

## Пояснения от dparhonin
Что было допилено по сравнению с оригинальными проектами от munrexio и gostest:
1. Теперь для сохранения конфигурации можно использовать встроенный редактор конфига от HA. Яндекс требует, чтобы имена устройств и комнат были на русском (логично, Алиса не умеет по-английски) и чтобы конфиг был в UTF-8, а HA умеет сохранять конфиг только в Latin1. Теперь конфигурация выправляется при чтении в yandex2mqtt.
2. Если не делать проксирование, а напрямую писать плагином в Zigbee2MQTT топики, то Яндекс присылает в качестве значений умений не то, что ожидает, скажем, Xiaomi лампочка. Были прикручены valueMappings. Хотя, возможно, правильнее было бы написать некий MQTT прокси в виде HA аддона. UPD: пока неактуально, valueMappings захардкожены.
3. Убран оверрайд db/access_tokens.js - он теперь не нужен, местоположение файла БД с токенами задаётся параметром комнфигурации yandex2mqtt.
4. Конфигурация устройств была вынесена в отдельный файл (/share/y2m/devices.json). При первоначальной установке этот файл надо создать руками - в VSCode плагине делаем File->Open Folder->/share/y2m, затем создаём там файл devices.json. Пример содержимого: https://github.com/dparhonin/yandex2mqtt/blob/master/devices.json